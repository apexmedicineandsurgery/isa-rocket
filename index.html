<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Standard Atmosphere Explorer ðŸš€</title>
<style>
  :root{
    --w: 960px;
    --panel: 440px;
    --skyH: 560px;
    --brand: #0e7490;
    --marker: #fde047;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
    color:#0f172a; background:#f8fafc;
    display:flex; justify-content:center; padding:24px;
  }
  .app{
    width: min(100%, var(--w));
    background:white; border:1px solid #e2e8f0; border-radius:12px;
    box-shadow:0 6px 24px rgba(2,6,23,.08);
    overflow:hidden;
  }
  header{padding:16px 20px; border-bottom:1px solid #e2e8f0;
    display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  header h1{font-size:18px; margin:0}
  header .sub{color:#475569}

  .content{
    display:flex; flex-direction:row; gap:16px; padding:16px;
    flex-wrap:nowrap; 
  }
  .viz{flex:1 1 520px; min-width:420px}
  .panel{
    flex:0 0 var(--panel); min-width:340px;
    border-right:1px solid #e2e8f0; padding:12px;
  }

  /* Atmosphere column */
  .sky{
    position:relative; height:var(--skyH); border-radius:10px; overflow:hidden;
    background: linear-gradient(#9ad0ff 0%, #78b9ff 35%, #3575c3 60%, #0b2a52 85%, #000 100%);
    border:1px solid #dbeafe;
  }
  .scale{
    position:absolute; left:8px; top:8px; bottom:8px; width:56px;
    background:rgba(255,255,255,.12); border-radius:8px;
    color:#e2e8f0; font-size:12px;
  }
  .scale .ticks{position:absolute; inset:8px 6px;
    display:flex; flex-direction:column; justify-content:space-between; align-items:center}
  .scale .label{opacity:.95}
  .scale .axis{
    position:absolute; right:4px; top:8px; bottom:8px;
    width:1px; background:rgba(226,232,240,.6);
  }
  .scale::after{
    content:"Altitude (km)"; position:absolute; left:2px; top:50%;
    transform:translateY(-50%) rotate(180deg);
    writing-mode:vertical-rl; font-size:11px; opacity:.8
  }

  .band{position:absolute; left:72px; right:0; opacity:.22}
  .tropos{background:#ffffff; top:calc(var(--skyH) - var(--skyH) * 11/105); height:calc(var(--skyH) * 11/105);}
  .strato1{background:#ffdd57; top:calc(var(--skyH) - var(--skyH) * 20/105); height:calc(var(--skyH) * 9/105);}
  .strato2{background:#f97316; top:calc(var(--skyH) - var(--skyH) * 32/105); height:calc(var(--skyH) * 12/105);}
  .strato3{background:#fb7185; top:calc(var(--skyH) - var(--skyH) * 47/105); height:calc(var(--skyH) * 15/105);}
  .meso1{background:#a78bfa; top:calc(var(--skyH) - var(--skyH) * 51/105); height:calc(var(--skyH) * 4/105);}
  .meso2{background:#60a5fa; top:calc(var(--skyH) - var(--skyH) * 71/105); height:calc(var(--skyH) * 20/105);}

  .band-label{
    position:absolute; left:80px; font-size:12px; color:#0f172a;
    mix-blend-mode:luminosity; opacity:.9; padding:2px 6px;
    border-radius:6px; background:rgba(255,255,255,.25)
  }

  .rocket{
    position:absolute; left:136px; width:36px; height:36px; transform:translateY(0);
    display:grid; place-items:center;
  }
  .rocket svg{filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))}
  .flame{transform-origin:50% 0%; animation:flame .12s infinite alternate ease-in}
  @keyframes flame{from{transform:scaleY(.8)} to{transform:scaleY(1.15)}}

  .marker{
    position:absolute; left:72px; right:8px; height:0; border-top:1px dashed var(--marker);
  }
  .marker .lbl{
    position:absolute; left:8px; transform:translateY(-12px);
    background:rgba(0,0,0,.45); color:#fff; font-size:12px; padding:2px 6px; border-radius:6px;
    white-space:nowrap;
  }

  .controls{display:grid; gap:12px; padding:8px}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .row label{min-width:140px; color:#334155}
  input[type=range]{width:100%}
  .btn{
    background:var(--brand); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;
    box-shadow:0 4px 10px rgba(14,116,144,.3)
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .small{font-size:12px; color:#64748b}
  select, input[type=number]{
    padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff;
  }

  .grid{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:8px;
  }
  .card{
    background:#f1f5f9; border:1px solid #e2e8f0; border-radius:8px; padding:10px;
  }
  .card h3{margin:0 0 6px; font-size:14px; color:#0f172a}
  .val{font-size:18px; font-weight:600}
  .unit{font-size:12px; color:#475569; margin-left:6px}

  footer{padding:12px 16px; color:#64748b; border-top:1px solid #e2e8f0; font-size:12px}
  code{background:#e2e8f0; padding:2px 6px; border-radius:6px}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>Standard Atmosphere Explorer</h1>
    <div class="sub">Interactive ISA (0â€“105 km) with rocket ascent, markers, and unit toggles</div>
  </header>



    <aside class="panel">
      <div class="controls">
        <!-- Altitude: meters and feet (no decimals) -->
        <div class="row">
          <label for="alt">Altitude</label>
          <input type="range" id="alt" min="0" max="80000" step="10" value="0" />
          <input type="number" id="altNum" min="0" max="80000" step="10" value="0" style="width:120px"/> m
          <span id="altFt" class="small" aria-live="polite">0 ft</span>
        </div>

      
        <!-- Animation controls -->
	<!-- Row 1: Play, Pause, Reset -->
	<div class="row">
 	 <button class="btn" id="launch">Play launch</button>
 	 <button class="btn" id="pause" disabled>Pause</button>
  	<button class="btn" id="reset">Reset</button>
	</div>

	<!-- Row 2: Rate slider -->
	<div class="row">
  	<span class="small">
  	  Rate: <input type="range" id="rate" min="0.1" max="20" step="0.1" value="10">
  	  <span id="rateLbl" class="small">10Ã— speed</span>
  	</span>
	</div>

      <!-- Readouts -->
      <div class="grid">

	<div class="card">
  	<h3>Altitude</h3>
  	<div><span class="val" id="alt_m">0</span><span class="unit">m</span></div>
 	 <div class="small"><span id="alt_ft">0</span> ft</div>
	</div>

        <div class="card">
	<h3>Layer</h3>
	<div class="val" id="layerName">Troposphere</div>
	</div>

        <div class="card">
  	<h3>Temperature</h3>
  	<div><span class="val" id="T_C">15.00</span><span class="unit">Â°C</span></div>
  	<div><span class="val" id="T_F">59.00</span><span class="unit">Â°F</span></div>
  	<div><span class="val" id="T_K">288.15</span><span class="unit">K</span></div>
	</div>

       <div class="card">
 	 <h3>Pressure</h3>
	<div><span class="val" id="P_kPa">101.33</span><span class="unit">kPa</span></div>  	
	<div><span class="val" id="P_psi">14.70</span><span class="unit">psi</span></div>
  	<div><span class="val" id="P_mmHg">760.00</span><span class="unit">mmHg</span></div>
	</div>

        <div class="card"><h3>Density</h3>
          <div><span class="val" id="rho">1.2250</span><span class="unit">kg/mÂ³</span></div>
        </div>

	<div class="card"><h3>Vehicle speed</h3>
	  <div><span class="val" id="Vnow">0.00</span><span class="unit">m/s</span></div>
	</div>

        <div class="card"><h3>Speed of sound</h3>
          <div><span class="val" id="a">340.29</span><span class="unit">m/s</span></div>
        </div>

        <div class="card"><h3>Mach number</h3>
          <div><span class="val" id="M">0.88</span><span class="unit">M</span></div>
        </div>
      </div>
    </aside>

  <div class="content">
    <section class="viz">
      <div class="sky" id="sky">
        <!-- altitude scale -->
        <div class="scale" aria-hidden="true">
          <div class="axis"></div>
          <div class="ticks">
            <div class="label">105</div>
            <div class="label">80</div>
            <div class="label">60</div>
            <div class="label">40</div>
            <div class="label">20</div>
            <div class="label">0</div>
          </div>
        </div>

        <!-- Layer bands (visual only) -->
        <div class="band tropos"></div>
        <div class="band strato1"></div>
        <div class="band strato2"></div>
        <div class="band strato3"></div>
        <div class="band meso1"></div>
        <div class="band meso2"></div>

        <!-- Labels -->
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*5.5/105);">Troposphere (0â€“11 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*16/105);">Lower Stratosphere (11â€“20 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*28/105);">Middle Stratosphere (20â€“32 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*40/105);">Upper Stratosphere (32â€“47 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*50/105);">Stratopause (47â€“51 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*61/105);">Mesosphere (51â€“80 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*90/105);">Thermosphere (80â€“600 km)</div>

        <!-- Armstrong and KÃ¡rmÃ¡n markers -->
        <div class="marker" id="armstrong"><span class="lbl">Armstrong line â‰ˆ19.2 km (63,000 ft)</span></div>
        <div class="marker" id="karman"><span class="lbl">KÃ¡rmÃ¡n line 100 km</span></div>

        <!-- Rocket -->
        <div class="rocket" id="rocket" aria-label="rocket">
          <svg width="36" height="36" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="fl" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#ffd166"/>
                <stop offset=".6" stop-color="#ef4444"/>
                <stop offset="1" stop-color="#7c2d12"/>
              </linearGradient>
            </defs>
            <!-- body -->
            <path d="M32 4c8 6 12 16 12 28 0 12-4 16-12 24-8-8-12-12-12-24 0-12 4-22 12-28z" fill="#e2e8f0" stroke="#0f172a" stroke-width="2"/>
            <circle cx="32" cy="24" r="6" fill="#60a5fa" stroke="#0f172a" stroke-width="2"/>
            <!-- fins -->
            <path d="M20 42l-8 6 8-2z" fill="#ef4444"/><path d="M44 42l8 6-8-2z" fill="#ef4444"/>
            <!-- flame -->
            <path class="flame" d="M32 58c-4-6 0-10 0-10s4 4 0 10z" fill="url(#fl)"/>
          </svg>
        </div>
      </div>
    </section>

  </div>

  <footer>
    ISA 1976 layer set (0â€“80 km). Calculations assume dry air and hydrostatic balance; visualization shows markers for Armstrong (~19.2 km) and KÃ¡rmÃ¡n (100 km). Extended view 80â€“105 km is visual only.
  </footer>
</div>

<script>
/* Physical constants */
const g0 = 9.80665;      // m/s^2
const R  = 287.05287;    // J/(kgÂ·K)
const gamma = 1.4;       // ratio of specific heats

/* Sea-level reference */
const T0 = 288.15;       // K
const P0 = 101325;       // Pa

/* Display range (visual) */
const MAX_ALT = 105000;  // m (0â€“105 km view)

/* Markers */
const ARM_KM = 19.2 * 1000;    // 19.2 km
const KARMAN_KM = 100 * 1000;  // 100 km

/* ISA 1976 layers up to 80 km:
   hb (m), L (K/m), label */
const layers = [
  { hb:    0,    L: -0.0065, label: "Troposphere (0â€“11 km)" },
  { hb: 11000,   L:  0.0,    label: "Lower Stratosphere (11â€“20 km)" },
  { hb: 20000,   L:  0.0010, label: "Middle Stratosphere (20â€“32 km)" },
  { hb: 32000,   L:  0.0028, label: "Upper Stratosphere (32â€“47 km)" },
  { hb: 47000,   L:  0.0,    label: "Stratopause (47â€“51 km)" },
  { hb: 51000,   L: -0.0028, label: "Lower Mesosphere (51â€“71 km)" },
  { hb: 71000,   L: -0.0020, label: "Upper Mesosphere (71â€“80 km)" }
];

/* Precompute base T and P for each layer for continuity */
function computeBases() {
  layers[0].Tb = T0;
  layers[0].Pb = P0;

  for (let i = 1; i < layers.length; i++) {
    const prev = layers[i-1];
    const curr = layers[i];
    const hdiff = curr.hb - prev.hb;

    // Temperature at start of this layer
    curr.Tb = (prev.L !== 0) ? prev.Tb + prev.L * hdiff : prev.Tb;

    // Pressure at start of this layer
    if (prev.L !== 0) {
      curr.Pb = prev.Pb * Math.pow(curr.Tb / prev.Tb, -g0 / (prev.L * R));
    } else {
      curr.Pb = prev.Pb * Math.exp(-g0 * hdiff / (R * prev.Tb));
    }
  }
}
computeBases();

/* Find active layer for altitude h (m). Clamp to last defined layer for h >= 80 km */
function getLayerIndex(h) {
  let idx = layers.length - 1;
  for (let i = 0; i < layers.length; i++) {
    if (h < layers[i].hb) { idx = Math.max(0, i - 1); break; }
  }
  return idx;
}

/* ISA state at altitude h (0â€“80,000 m). Above 80 km, we hold the last gradient. */
function isa(h) {
  h = Math.max(0, Math.min(h, 80000)); // ISA validity clamp
  const idx = getLayerIndex(h);
  const base = layers[idx];
  const hb = base.hb, Tb = base.Tb, Pb = base.Pb, L = base.L;
  const dh = h - hb;

  let T, P;
  if (L === 0) {
    T = Tb;
    P = Pb * Math.exp(-g0 * dh / (R * Tb));
  } else {
    T = Tb + L * dh;
    P = Pb * Math.pow(T / Tb, -g0 / (L * R));
  }
  const rho = P / (R * T);
  const a = Math.sqrt(gamma * R * T);
  return { T, P, rho, a, label: base.label };
}

/* Unit conversions */
function speedToMps(v, unit){
  switch(unit){
    case 'kts':  return v * 0.514444;
    case 'kmph': return v / 3.6;
    case 'mph':  return v * 0.44704;
    case 'mps':
    default:     return v;
  }
}

/* DOM */
const alt = document.getElementById('alt');
const altNum = document.getElementById('altNum');
const altFt = document.getElementById('altFt');
const rhoEl = document.getElementById('rho');
const aEl = document.getElementById('a');
const layerEl = document.getElementById('layerName');
const rocket = document.getElementById('rocket');
const sky = document.getElementById('sky');
const launchBtn = document.getElementById('launch');
const pauseBtn = document.getElementById('pause');
const rate = document.getElementById('rate');
const rateLbl = document.getElementById('rateLbl');
const resetBtn = document.getElementById('reset');
const MEl = document.getElementById('M');
const armLine = document.getElementById('armstrong');
const karLine = document.getElementById('karman');
const VnowEl = document.getElementById('Vnow');
const T_C_El = document.getElementById('T_C');
const T_F_El = document.getElementById('T_F');
const T_K_El = document.getElementById('T_K');
const P_mmHg_El = document.getElementById('P_mmHg');
const P_psi_El  = document.getElementById('P_psi');
const P_kPa_El  = document.getElementById('P_kPa');
const alt_m_El = document.getElementById('alt_m');
const alt_ft_El = document.getElementById('alt_ft');

function fmt(n, d=2) { return n.toLocaleString(undefined, {maximumFractionDigits:d, minimumFractionDigits:d}); }
function fmtInt(n) { return Math.round(n).toLocaleString(undefined, {maximumFractionDigits:0}); }

/* Map altitude (m) to Y position within sky (0 at top) */
function altToY(h){
  const skyH = sky.getBoundingClientRect().height;
  const clamped = Math.max(0, Math.min(MAX_ALT, h));
  return skyH - (clamped / MAX_ALT) * skyH;
}

function positionMarkers(){
  armLine.style.top = `${altToY(ARM_KM)}px`;
  karLine.style.top = `${altToY(KARMAN_KM)}px`;
}

/* Update UI with state at altitude */
function updateUI(h){
  // Normalize and sync inputs (no decimals for altitude displays)
  h = Math.max(0, Math.min(MAX_ALT, Number.isFinite(h) ? h : 0));
  const hInt = Math.round(h / 10) * 10; // keep slider step alignment
  alt.value = hInt;
  altNum.value = hInt;           // meters, integer
  altFt.textContent = `${fmtInt(hInt * 3.28084)} ft`; // feet, integer
  alt_m_El.textContent = fmtInt(hInt);
  alt_ft_El.textContent = fmtInt(hInt * 3.28084);

  // Atmosphere state (clamped to 80 km for ISA)
  const state = isa(hInt);
  const { T:TK, P:Pa, rho, a, label } = state;

  // Temperature: show C, F, K simultaneously
  const C = TK - 273.15;
  const F = (C * 9/5) + 32;
  const K = TK;
  T_C_El.textContent = fmt(C, 2);
  T_F_El.textContent = fmt(F, 2);
  T_K_El.textContent = fmt(K, 2);

  // Pressure: show mmHg, psi, kPa simultaneously
  const mmHg = Pa * 760 / 101325;
  const psi  = Pa / 6894.75729;
  const kPa  = Pa / 1000;
  P_mmHg_El.textContent = fmt(mmHg, 2);
  P_psi_El.textContent  = fmt(psi, 2);
  P_kPa_El.textContent  = fmt(kPa, 2);

  // Density & a (fixed units)
  rhoEl.textContent = fmt(rho, 4);
  aEl.textContent = fmt(a, 2);
  layerEl.textContent = label;

  // Mach from user speed


  // Vehicle speed and Mach from current ascent state
  VnowEl.textContent = fmt(vNowCurrent, 2);
  const M = a > 0 ? vNowCurrent / a : 0;
  MEl.textContent = fmt(M, 3);

  // Move rocket (center offset for SVG height)
  const y = altToY(hInt) - 18;
  rocket.style.transform = `translateY(${y}px)`;
}

// --- Falcon 9 + Dragon ascent (proper Gx, real-time) ---
const BASELINE_TIME = 540;  // seconds to ~SECO-1
const DT = 0.05;            // integration step (s)

// Proper crew G timeline (coarse but realistic shape)
// Events: liftoff, Max Q bucket, MECO, sep/coast, S2 ignition, ramp, SECO.
const accelProfile = [
  // Stage 1
  { t:   0, g: 1.15 },  // liftoff (>1g proper)
  { t:  10, g: 1.25 },
  { t:  50, g: 2.10 },
  { t:  70, g: 1.60 },  // throttle bucket near Max Q
  { t: 120, g: 2.50 },
  { t: 145, g: 3.30 },  // rising as mass drops
  { t: 150, g: 1.50 },  // pre-MECO throttle down
  { t: 153, g: 0.00 },  // MECO
  // Sep/coast
  { t: 158, g: 0.00 },
  // Stage 2
  { t: 165, g: 0.60 },
  { t: 240, g: 1.20 },
  { t: 360, g: 2.00 },
  { t: 480, g: 3.00 },
  { t: 520, g: 3.60 },  // cap under ~4g for crew comfort
  { t: 535, g: 2.00 },  // throttle down before SECO
  { t: 540, g: 0.00 }   // SECO-1
];

// Interpolate proper G at time t
function gProperAt(t){
  if (t <= accelProfile[0].t) return accelProfile[0].g;
  for (let i = 0; i < accelProfile.length - 1; i++) {
    const a = accelProfile[i], b = accelProfile[i+1];
    if (t >= a.t && t <= b.t) {
      const f = (t - a.t) / (b.t - a.t);
      return a.g + f * (b.g - a.g);
    }
  }
  return accelProfile[accelProfile.length - 1].g;
}

// Build baseline table: time, altitude, velocity
let baselineTable = [];
(function buildBaseline(){
  let v = 0, h = 0;
  for (let t = 0; t <= BASELINE_TIME + 1e-9; t += DT) {
    // Proper (felt) g -> net vertical acceleration: subtract gravity
    const gProper = gProperAt(t);
    const a_net = (gProper - 1) * g0;  // m/s^2

    v += a_net * DT;           // m/s
    h += Math.max(0, v) * DT;  // m (prevent negative altitude dips)

    baselineTable.push({ t, alt: h, vel: v });
  }
})();

/* Animation */
let anim = null;
let vNowCurrent = 0;
let startPerf = null;
let pausedTime = 0;
let playbackRate = 1;      // baseline 1Ã—
rate.value = 1;
rateLbl.textContent = "1Ã— speed";


function tick(tsNow) {
  if (!startPerf) startPerf = tsNow;
  const elapsedReal = (tsNow - startPerf) / 1000;

  // Physics time scales with Rate
  const elapsedPhysics = pausedTime + elapsedReal * playbackRate;
  const tNow = Math.min(elapsedPhysics, BASELINE_TIME);

  // Index into baseline by DT (fast and stable)
  let i = Math.floor(tNow / DT);
  if (i >= baselineTable.length) i = baselineTable.length - 1;

  const point = baselineTable[i];
  let h = point.alt;
  const v = point.vel;

  // â›” Stop if we hit or exceed 80 km
  if (h >= 80000) {
    h = 80000;          // lock the display
    vNowCurrent = 0;    // freeze velocity readout (optional)
    updateUI(h);
    stop();
    return;             // exit tick()
  }

  vNowCurrent = v;
  updateUI(h);

  if (tNow < BASELINE_TIME) {
    anim = requestAnimationFrame(tick);
  } else {
    stop();
  }
}


function start() {
  if (pausedTime >= BASELINE_TIME) {
    pausedTime = 0; // restart
  }
  startPerf = null;
  launchBtn.disabled = true;
  pauseBtn.disabled = false;
  anim = requestAnimationFrame(tick);
}

function stop() {
  if (startPerf !== null) {
    const elapsedReal = (performance.now() - startPerf) / 1000;
    pausedTime += elapsedReal * playbackRate;
  }
  // if run completed, reset pausedTime
  if (pausedTime >= BASELINE_TIME) {
    pausedTime = 0;
  }

  launchBtn.disabled = false;
  pauseBtn.disabled = true;
  if (anim) cancelAnimationFrame(anim);
  anim = null;
}

/* Events */
alt.addEventListener('input', e => updateUI(parseFloat(e.target.value)));
altNum.addEventListener('input', e => updateUI(parseFloat(e.target.value)||0));
launchBtn.addEventListener('click', start);
pauseBtn.addEventListener('click', stop);

function resetAnim() {
  if (anim) cancelAnimationFrame(anim);
  anim = null;
  startPerf = null;
  pausedTime = 0;
  vNowCurrent = 0;

  updateUI(0);

  playbackRate = 1;
  rate.value = 1;
  rateLbl.textContent = "1Ã— speed";

  launchBtn.disabled = false;
  pauseBtn.disabled = true;
}

resetBtn.addEventListener('click', resetAnim);

rate.addEventListener('input', e => {
  playbackRate = parseFloat(e.target.value);
  rateLbl.textContent = `${playbackRate.toFixed(1)}Ã— speed`;
});

window.addEventListener('resize', positionMarkers);

/* Init */
positionMarkers();
updateUI(0);
</script>
</body>
</html>
