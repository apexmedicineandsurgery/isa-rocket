<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Standard Atmosphere Explorer ðŸš€</title>
<style>
  :root{
    --w: 960px;
    --panel: 440px;
    --skyH: 560px;
    --brand: #0e7490;
    --marker: #fde047;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif; color:#0f172a; background:#f8fafc;
    display:flex; justify-content:center; padding:24px;
  }
  .app{
    width: min(100%, var(--w));
    background:white; border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 6px 24px rgba(2,6,23,.08);
    overflow:hidden;
  }
  header{padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  header h1{font-size:18px; margin:0}
  header .sub{color:#475569}

  .content{display:flex; gap:16px; padding:16px; flex-wrap:wrap}
  .viz{flex:1 1 520px; min-width:420px}
  .panel{flex:0 0 var(--panel); min-width:340px; border-left:1px solid #e2e8f0; padding:12px}

  /* Atmosphere column */
  .sky{
    position:relative; height:var(--skyH); border-radius:10px; overflow:hidden;
    background: linear-gradient(#9ad0ff 0%, #78b9ff 35%, #3575c3 60%, #0b2a52 85%, #000 100%);
    border:1px solid #dbeafe;
  }
  .scale{
    position:absolute; left:8px; top:8px; bottom:8px; width:56px; background:rgba(255,255,255,.12); border-radius:8px;
    color:#e2e8f0; font-size:12px;
  }
  .scale .ticks{position:absolute; inset:8px 6px; display:flex; flex-direction:column; justify-content:space-between; align-items:center}
  .scale .label{opacity:.95}
  .scale .axis{
    position:absolute; right:4px; top:8px; bottom:8px; width:1px; background:rgba(226,232,240,.6);
  }
  .scale::after{
    content:"Altitude (km)"; position:absolute; left:2px; top:50%; transform:translateY(-50%) rotate(180deg);
    writing-mode:vertical-rl; font-size:11px; opacity:.8
  }

  /* Layer bands (visual only, sized to 0â€“80 km within a 0â€“105 km viewport) */
  .band{position:absolute; left:72px; right:0; opacity:.22}
  .tropos{background:#ffffff; top:calc(var(--skyH) - var(--skyH) * 11/105); height:calc(var(--skyH) * 11/105);}
  .strato1{background:#ffdd57; top:calc(var(--skyH) - var(--skyH) * 20/105); height:calc(var(--skyH) * 9/105);}
  .strato2{background:#f97316; top:calc(var(--skyH) - var(--skyH) * 32/105); height:calc(var(--skyH) * 12/105);}
  .strato3{background:#fb7185; top:calc(var(--skyH) - var(--skyH) * 47/105); height:calc(var(--skyH) * 15/105);}
  .meso1{background:#a78bfa; top:calc(var(--skyH) - var(--skyH) * 51/105); height:calc(var(--skyH) * 4/105);}
  .meso2{background:#60a5fa; top:calc(var(--skyH) - var(--skyH) * 71/105); height:calc(var(--skyH) * 20/105);}

  .band-label{
    position:absolute; left:80px; font-size:12px; color:#0f172a; mix-blend-mode:luminosity; opacity:.9;
    padding:2px 6px; border-radius:6px; background:rgba(255,255,255,.25)
  }

  /* Rocket */
  .rocket{
    position:absolute; left:136px; width:36px; height:36px; transform:translateY(0);
    display:grid; place-items:center;
  }
  .rocket svg{filter:drop-shadow(0 2px 4px rgba(0,0,0,.35))}
  .flame{transform-origin:50% 0%; animation:flame .12s infinite alternate ease-in}
  @keyframes flame{from{transform:scaleY(.8)} to{transform:scaleY(1.15)}}

  /* Markers */
  .marker{
    position:absolute; left:72px; right:8px; height:0; border-top:1px dashed var(--marker);
  }
  .marker .lbl{
    position:absolute; left:8px; transform:translateY(-12px);
    background:rgba(0,0,0,.45); color:#fff; font-size:12px; padding:2px 6px; border-radius:6px;
    white-space:nowrap;
  }

  /* Controls */
  .controls{display:grid; gap:12px; padding:8px}
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .row label{min-width:140px; color:#334155}
  input[type=range]{width:100%}
  .btn{
    background:var(--brand); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer;
    box-shadow:0 4px 10px rgba(14,116,144,.3)
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .small{font-size:12px; color:#64748b}
  select, input[type=number]{
    padding:6px 8px; border:1px solid #cbd5e1; border-radius:8px; background:#fff;
  }

  /* Readouts */
  .grid{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:8px;
  }
  .card{
    background:#f1f5f9; border:1px solid #e2e8f0; border-radius:8px; padding:10px;
  }
  .card h3{margin:0 0 6px; font-size:14px; color:#0f172a}
  .val{font-size:18px; font-weight:600}
  .unit{font-size:12px; color:#475569; margin-left:6px}

  footer{padding:12px 16px; color:#64748b; border-top:1px solid #e2e8f0; font-size:12px}
  code{background:#e2e8f0; padding:2px 6px; border-radius:6px}
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <h1>Standard Atmosphere Explorer</h1>
    <div class="sub">Interactive ISA (0â€“105 km) with rocket ascent, markers, and unit toggles</div>
  </header>

  <div class="content">
    <section class="viz">
      <div class="sky" id="sky">
        <!-- altitude scale -->
        <div class="scale" aria-hidden="true">
          <div class="axis"></div>
          <div class="ticks">
            <div class="label">105</div>
            <div class="label">80</div>
            <div class="label">60</div>
            <div class="label">40</div>
            <div class="label">20</div>
            <div class="label">0</div>
          </div>
        </div>

        <!-- Layer bands (visual only) -->
        <div class="band tropos"></div>
        <div class="band strato1"></div>
        <div class="band strato2"></div>
        <div class="band strato3"></div>
        <div class="band meso1"></div>
        <div class="band meso2"></div>

        <!-- Labels -->
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*5.5/105);">Troposphere (0â€“11 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*16/105);">Lower Stratosphere (11â€“20 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*28/105);">Mid Stratosphere (20â€“32 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*40/105);">Upper Stratosphere (32â€“47 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*50/105);">Stratopause (47â€“51 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*61/105);">Mesosphere (51â€“80 km)</div>
        <div class="band-label" style="top: calc(var(--skyH) - var(--skyH)*90/105);">Exosphere visual (80â€“105 km)</div>

        <!-- Armstrong and KÃ¡rmÃ¡n markers -->
        <div class="marker" id="armstrong"><span class="lbl">Armstrong line â‰ˆ19.2 km (63,000 ft)</span></div>
        <div class="marker" id="karman"><span class="lbl">KÃ¡rmÃ¡n line 100 km</span></div>

        <!-- Rocket -->
        <div class="rocket" id="rocket" aria-label="rocket">
          <svg width="36" height="36" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
            <defs>
              <linearGradient id="fl" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0" stop-color="#ffd166"/>
                <stop offset=".6" stop-color="#ef4444"/>
                <stop offset="1" stop-color="#7c2d12"/>
              </linearGradient>
            </defs>
            <!-- body -->
            <path d="M32 4c8 6 12 16 12 28 0 12-4 16-12 24-8-8-12-12-12-24 0-12 4-22 12-28z" fill="#e2e8f0" stroke="#0f172a" stroke-width="2"/>
            <circle cx="32" cy="24" r="6" fill="#60a5fa" stroke="#0f172a" stroke-width="2"/>
            <!-- fins -->
            <path d="M20 42l-8 6 8-2z" fill="#ef4444"/><path d="M44 42l8 6-8-2z" fill="#ef4444"/>
            <!-- flame -->
            <path class="flame" d="M32 58c-4-6 0-10 0-10s4 4 0 10z" fill="url(#fl)"/>
          </svg>
        </div>
      </div>
    </section>

    <aside class="panel">
      <div class="controls">
        <!-- Altitude: meters and feet (no decimals) -->
        <div class="row">
          <label for="alt">Altitude</label>
          <input type="range" id="alt" min="0" max="105000" step="10" value="0" />
          <input type="number" id="altNum" min="0" max="105000" step="10" value="0" style="width:120px"/>
          <span id="altFt" class="small" aria-live="polite">0 ft</span>
        </div>

        <!-- Temperature unit row -->
        <div class="row">
          <label>Temperature unit</label>
          <select id="tUnit">
            <option value="C" selected>Â°C</option>
            <option value="K">K</option>
            <option value="F">Â°F</option>
          </select>
        </div>

        <!-- Pressure unit row (moved below temperature unit) -->
        <div class="row">
          <label>Pressure unit</label>
          <select id="pUnit">
            <option value="mmHg" selected>mmHg</option>
            <option value="kPa">kPa</option>
            <option value="psi">psi</option>
            <option value="Pa">Pa</option>
          </select>
        </div>

        <!-- Vehicle speed for Mach -->
        <div class="row">
          <label>Vehicle speed</label>
          <input type="number" id="speedVal" value="300" step="1" style="width:120px"/>
          <select id="speedUnit">
            <option value="mps" selected>m/s</option>
            <option value="kts">kt</option>
            <option value="kmph">km/h</option>
            <option value="mph">mph</option>
          </select>
          <span class="small">Mach vs local a</span>
        </div>

        <!-- Animation controls -->
        <div class="row">
          <button class="btn" id="launch">Play launch</button>
          <button class="btn" id="pause" disabled>Pause</button>
          <span class="small">Rate: <input type="range" id="rate" min="50" max="800" step="10" value="250"> <span id="rateLbl" class="small">250 m/s</span></span>
        </div>
      </div>

      <!-- Readouts -->
      <div class="grid">
        <div class="card"><h3>Layer</h3><div class="val" id="layerName">Troposphere</div></div>

        <div class="card"><h3>Temperature</h3>
          <div><span class="val" id="T">15</span><span class="unit" id="Tunit">Â°C</span></div>
        </div>

        <div class="card"><h3>Pressure</h3>
          <div><span class="val" id="P">760.00</span><span class="unit" id="Punit">mmHg</span></div>
        </div>

        <div class="card"><h3>Density</h3>
          <div><span class="val" id="rho">1.2250</span><span class="unit">kg/mÂ³</span></div>
        </div>

        <div class="card"><h3>Speed of sound</h3>
          <div><span class="val" id="a">340.29</span><span class="unit">m/s</span></div>
        </div>

        <div class="card"><h3>Mach number</h3>
          <div><span class="val" id="M">0.88</span><span class="unit">M</span></div>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    ISA 1976 layer set (0â€“80 km). Calculations assume dry air and hydrostatic balance; visualization shows markers for Armstrong (~19.2 km) and KÃ¡rmÃ¡n (100 km). Extended view 80â€“105 km is visual only.
  </footer>
</div>

<script>
/* Physical constants */
const g0 = 9.80665;      // m/s^2
const R  = 287.05287;    // J/(kgÂ·K)
const gamma = 1.4;       // ratio of specific heats

/* Sea-level reference */
const T0 = 288.15;       // K
const P0 = 101325;       // Pa

/* Display range (visual) */
const MAX_ALT = 105000;  // m (0â€“105 km view)

/* Markers */
const ARM_KM = 19.2 * 1000;    // 19.2 km
const KARMAN_KM = 100 * 1000;  // 100 km

/* ISA 1976 layers up to 80 km:
   hb (m), L (K/m), label */
const layers = [
  { hb:    0,    L: -0.0065, label: "Troposphere (0â€“11 km)" },
  { hb: 11000,   L:  0.0,    label: "Lower Stratosphere (11â€“20 km)" },
  { hb: 20000,   L:  0.0010, label: "Stratosphere (20â€“32 km)" },
  { hb: 32000,   L:  0.0028, label: "Stratosphere (32â€“47 km)" },
  { hb: 47000,   L:  0.0,    label: "Stratopause (47â€“51 km)" },
  { hb: 51000,   L: -0.0028, label: "Mesosphere (51â€“71 km)" },
  { hb: 71000,   L: -0.0020, label: "Mesosphere (71â€“80 km)" }
];

/* Precompute base T and P for each layer for continuity */
function computeBases() {
  layers[0].Tb = T0;
  layers[0].Pb = P0;

  for (let i = 1; i < layers.length; i++) {
    const prev = layers[i-1];
    const curr = layers[i];
    const hdiff = curr.hb - prev.hb;

    // Temperature at start of this layer
    curr.Tb = (prev.L !== 0) ? prev.Tb + prev.L * hdiff : prev.Tb;

    // Pressure at start of this layer
    if (prev.L !== 0) {
      curr.Pb = prev.Pb * Math.pow(curr.Tb / prev.Tb, -g0 / (prev.L * R));
    } else {
      curr.Pb = prev.Pb * Math.exp(-g0 * hdiff / (R * prev.Tb));
    }
  }
}
computeBases();

/* Find active layer for altitude h (m). Clamp to last defined layer for h >= 80 km */
function getLayerIndex(h) {
  let idx = layers.length - 1;
  for (let i = 0; i < layers.length; i++) {
    if (h < layers[i].hb) { idx = Math.max(0, i - 1); break; }
  }
  return idx;
}

/* ISA state at altitude h (0â€“80,000 m). Above 80 km, we hold the last gradient. */
function isa(h) {
  h = Math.max(0, Math.min(h, 80000)); // ISA validity clamp
  const idx = getLayerIndex(h);
  const base = layers[idx];
  const hb = base.hb, Tb = base.Tb, Pb = base.Pb, L = base.L;
  const dh = h - hb;

  let T, P;
  if (L === 0) {
    T = Tb;
    P = Pb * Math.exp(-g0 * dh / (R * Tb));
  } else {
    T = Tb + L * dh;
    P = Pb * Math.pow(T / Tb, -g0 / (L * R));
  }
  const rho = P / (R * T);
  const a = Math.sqrt(gamma * R * T);
  return { T, P, rho, a, label: base.label };
}

/* Unit conversions */
function toTemp(TK, unit) {
  if (unit === 'K') return { val: TK, u: 'K' };
  const C = TK - 273.15;
  if (unit === 'C') return { val: C, u: 'Â°C' };
  return { val: (C * 9/5) + 32, u: 'Â°F' };
}
function toPress(Pa, unit) {
  switch(unit){
    case 'mmHg': return { val: Pa * 760/101325, u: 'mmHg' };
    case 'kPa':  return { val: Pa / 1000,       u: 'kPa' };
    case 'psi':  return { val: Pa / 6894.75729, u: 'psi' };
    case 'Pa':
    default:     return { val: Pa,              u: 'Pa' };
  }
}
function speedToMps(v, unit){
  switch(unit){
    case 'kts':  return v * 0.514444;
    case 'kmph': return v / 3.6;
    case 'mph':  return v * 0.44704;
    case 'mps':
    default:     return v;
  }
}

/* DOM */
const alt = document.getElementById('alt');
const altNum = document.getElementById('altNum');
const altFt = document.getElementById('altFt');
const TEl = document.getElementById('T');
const PEl = document.getElementById('P');
const rhoEl = document.getElementById('rho');
const aEl = document.getElementById('a');
const layerEl = document.getElementById('layerName');
const rocket = document.getElementById('rocket');
const sky = document.getElementById('sky');
const launchBtn = document.getElementById('launch');
const pauseBtn = document.getElementById('pause');
const rate = document.getElementById('rate');
const rateLbl = document.getElementById('rateLbl');
const tUnit = document.getElementById('tUnit');
const pUnit = document.getElementById('pUnit');
const Tunit = document.getElementById('Tunit');
const Punit = document.getElementById('Punit');
const speedVal = document.getElementById('speedVal');
const speedUnit = document.getElementById('speedUnit');
const MEl = document.getElementById('M');
const armLine = document.getElementById('armstrong');
const karLine = document.getElementById('karman');

function fmt(n, d=2) { return n.toLocaleString(undefined, {maximumFractionDigits:d, minimumFractionDigits:d}); }
function fmtInt(n) { return Math.round(n).toLocaleString(undefined, {maximumFractionDigits:0}); }

/* Map altitude (m) to Y position within sky (0 at top) */
function altToY(h){
  const skyH = sky.getBoundingClientRect().height;
  const clamped = Math.max(0, Math.min(MAX_ALT, h));
  return skyH - (clamped / MAX_ALT) * skyH;
}

function positionMarkers(){
  armLine.style.top = `${altToY(ARM_KM)}px`;
  karLine.style.top = `${altToY(KARMAN_KM)}px`;
}

/* Update UI with state at altitude */
function updateUI(h){
  // Normalize and sync inputs (no decimals for altitude displays)
  h = Math.max(0, Math.min(MAX_ALT, Number.isFinite(h) ? h : 0));
  const hInt = Math.round(h / 10) * 10; // keep slider step alignment
  alt.value = hInt;
  altNum.value = hInt;           // meters, integer
  altFt.textContent = `${fmtInt(hInt * 3.28084)} ft`; // feet, integer

  // Atmosphere state (clamped to 80 km for ISA)
  const state = isa(hInt);
  const { T:TK, P:Pa, rho, a, label } = state;

  // Temperature
  const t = toTemp(TK, tUnit.value);
  TEl.textContent = (tUnit.value === 'K') ? fmt(t.val, 2) : fmt(t.val, 2);
  Tunit.textContent = t.u;

  // Pressure
  const p = toPress(Pa, pUnit.value);
  PEl.textContent = fmt(p.val, (pUnit.value === 'Pa') ? 0 : 2);
  Punit.textContent = p.u;

  // Density & a (fixed units)
  rhoEl.textContent = fmt(rho, 4);
  aEl.textContent = fmt(a, 2);
  layerEl.textContent = label;

  // Mach from user speed
  const vMps = speedToMps(parseFloat(speedVal.value) || 0, speedUnit.value);
  const M = a > 0 ? vMps / a : 0;
  MEl.textContent = fmt(M, 3);

  // Move rocket (center offset for SVG height)
  const y = altToY(hInt) - 18;
  rocket.style.transform = `translateY(${y}px)`;
}

/* Animation */
let anim = null;
function tick(tsPrev, lastH){
  anim = requestAnimationFrame((tsNow) => {
    const dt = Math.min(1/30, (tsNow - tsPrev)/1000); // cap timestep
    const v = parseFloat(rate.value); // m/s ascent rate (visual only)
    const h = Math.min(MAX_ALT, lastH + v*dt);
    updateUI(h);
    if (h >= MAX_ALT) { stop(); return; }
    tick(tsNow, h);
  });
}
function start(){
  launchBtn.disabled = true; pauseBtn.disabled = false;
  const startH = parseFloat(alt.value) || 0;
  const now = performance.now();
  tick(now, startH);
}
function stop(){
  launchBtn.disabled = false; pauseBtn.disabled = true;
  if (anim) cancelAnimationFrame(anim);
  anim = null;
}

/* Events */
alt.addEventListener('input', e => updateUI(parseFloat(e.target.value)));
altNum.addEventListener('input', e => updateUI(parseFloat(e.target.value)||0));
launchBtn.addEventListener('click', start);
pauseBtn.addEventListener('click', stop);
rate.addEventListener('input', e => rateLbl.textContent = `${e.target.value} m/s`);
tUnit.addEventListener('change', () => updateUI(parseFloat(alt.value)));
pUnit.addEventListener('change', () => updateUI(parseFloat(alt.value)));
speedVal.addEventListener('input', () => updateUI(parseFloat(alt.value)));
speedUnit.addEventListener('change', () => updateUI(parseFloat(alt.value)));
window.addEventListener('resize', positionMarkers);

/* Init */
positionMarkers();
updateUI(0);
</script>
</body>
</html>
